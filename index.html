<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Data Extractor & Validator</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState } = React;
        const { AlertCircle, CheckCircle2, AlertTriangle, Download, Upload, FileText } = lucide;

        export default function InvoiceUploadValidator() {
          const [files, setFiles] = useState([]);
          const [loading, setLoading] = useState(false);
          const [results, setResults] = useState(null);
          const [error, setError] = useState('');

          const handleFileUpload = (e) => {
            const uploadedFiles = Array.from(e.target.files);
            setFiles(uploadedFiles);
            setError('');
            setResults(null);
          };

          const handleDragDrop = (e) => {
            e.preventDefault();
            const droppedFiles = Array.from(e.dataTransfer.files);
            setFiles(droppedFiles);
            setError('');
            setResults(null);
          };

          const generateMockExtraction = (fileName) => {
            if (fileName.includes('6815')) {
              return {
                invoiceNumber: '6815',
                invoiceDate: '04/09/2025',
                exporterName: 'Ecoworks Marine Ltd',
                exporterAddress: 'Bath, United Kingdom, BA1 2FJ',
                exporterEORI: 'GB202961529000',
                importerName: 'SRFACE B.V.',
                importerAddress: 'The Hague, Netherlands',
                importerVAT: 'NL858083796B01',
                shipDate: '17/09/2025',
                currency: 'GBP',
                incoterms: 'DAPC',
                lineItems: [
                  {
                    description: 'Wetsuit Wash 250ml',
                    quantity: 380,
                    unit: 'pieces',
                    unitPrice: 4.00,
                    totalPrice: 1520.00,
                    commodityCode: '3402500090',
                    weight: 70
                  }
                ],
                grossWeight: 289.11
              };
            }
            return {
              invoiceNumber: 'SAMPLE',
              invoiceDate: '01/01/2025',
              exporterName: 'Example Exporter',
              importerName: 'Example Importer',
              currency: 'USD',
              lineItems: [],
              error: 'Demo mode - actual file processing coming soon'
            };
          };

          const validateExtractedData = (data) => {
            const issues = [];
            const valid = [];

            if (!data.invoiceNumber || data.invoiceNumber.includes('NOT_FOUND')) {
              issues.push({ type: 'error', field: 'Invoice Number', message: 'Missing or not found' });
            } else {
              valid.push({ field: 'Invoice Number', value: data.invoiceNumber });
            }

            if (!data.currency || data.currency === 'NOT_FOUND') {
              issues.push({ type: 'error', field: 'Currency', message: 'Currency not specified' });
            } else {
              valid.push({ field: 'Currency', value: data.currency });
            }

            if (data.lineItems && data.lineItems.length > 0) {
              data.lineItems.forEach((item, idx) => {
                if (!item.commodityCode) {
                  issues.push({ type: 'error', field: `Line ${idx + 1}: Commodity Code`, message: 'Missing' });
                } else if (item.commodityCode.length !== 10) {
                  issues.push({ type: 'warning', field: `Line ${idx + 1}: Code ${item.commodityCode}`, message: `${item.commodityCode.length} digits - UK requires 10. Check: https://www.trade-tariff.service.gov.uk` });
                } else {
                  valid.push({ field: `Line ${idx + 1}: Code ${item.commodityCode}`, value: 'Valid format - verify at UK Trade Tariff' });
                }
              });
            }

            return { issues, valid };
          };

          const processFiles = async () => {
            if (files.length === 0) {
              setError('Please select at least one file');
              return;
            }

            setLoading(true);
            await new Promise(resolve => setTimeout(resolve, 1500));

            try {
              const processedResults = [];
              for (const file of files) {
                const mockExtraction = generateMockExtraction(file.name);
                const validationResult = validateExtractedData(mockExtraction);
                processedResults.push({
                  fileName: file.name,
                  extraction: mockExtraction,
                  validation: validationResult
                });
              }
              setResults(processedResults);
            } catch (err) {
              setError(`Error: ${err.message}`);
            }
            setLoading(false);
          };

          const downloadReport = (result) => {
            let reportText = `INVOICE VALIDATION REPORT\n`;
            reportText += `File: ${result.fileName}\n`;
            reportText += `Generated: ${new Date().toLocaleString()}\n`;
            reportText += '='.repeat(60) + '\n\n';
            reportText += `Invoice Number: ${result.extraction.invoiceNumber}\n`;
            reportText += `Currency: ${result.extraction.currency}\n\n`;
            
            if (result.validation.issues.length === 0) {
              reportText += 'âœ“ NO ISSUES FOUND\n\n';
            } else {
              reportText += 'ISSUES:\n';
              result.validation.issues.forEach(issue => {
                reportText += `[${issue.type.toUpperCase()}] ${issue.field}\n${issue.message}\n\n`;
              });
            }

            const blob = new Blob([reportText], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `validation-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
          };

          return (
            <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-8">
              <div className="max-w-5xl mx-auto">
                <div className="bg-white rounded-lg shadow-lg p-8">
                  <h1 className="text-3xl font-bold text-gray-800 mb-2">Invoice Data Extractor & Validator</h1>
                  <p className="text-gray-600 mb-8">Upload invoices to extract data and validate completeness</p>

                  <label
                    onDrop={handleDragDrop}
                    onDragOver={(e) => e.preventDefault()}
                    className="block border-2 border-dashed border-indigo-300 rounded-lg p-8 text-center hover:border-indigo-500 hover:bg-indigo-50 transition cursor-pointer"
                  >
                    <Upload className="mx-auto h-12 w-12 text-indigo-600 mb-2" />
                    <span className="text-indigo-700 font-medium">Click to upload or drag and drop</span>
                    <p className="text-indigo-600 text-sm mt-1">PDF, PNG, JPG, or DOCX files</p>
                    <input
                      type="file"
                      onChange={handleFileUpload}
                      className="hidden"
                      accept=".pdf,.png,.jpg,.jpeg,.docx"
                      multiple
                    />
                  </label>

                  {files.length > 0 && (
                    <div className="mt-6 p-4 bg-indigo-50 rounded-lg">
                      <p className="font-semibold text-gray-800">Selected: {files.map(f => f.name).join(', ')}</p>
                    </div>
                  )}

                  <button
                    onClick={processFiles}
                    disabled={files.length === 0 || loading}
                    className="w-full mt-6 bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-400 text-white font-bold py-3 rounded-lg"
                  >
                    {loading ? 'Processing...' : 'Extract & Validate'}
                  </button>

                  {error && (
                    <div className="mt-6 p-4 bg-red-50 border border-red-300 rounded text-red-700">
                      {error}
                    </div>
                  )}

                  {results && (
                    <div className="mt-8 space-y-6">
                      {results.map((result, idx) => (
                        <div key={idx} className="border border-gray-200 rounded-lg p-6 bg-gray-50">
                          <h3 className="text-xl font-bold text-gray-800">{result.fileName}</h3>
                          
                          {result.validation.issues.length > 0 && (
                            <div className="mt-4">
                              <h4 className="font-semibold text-gray-800 mb-2">Issues:</h4>
                              {result.validation.issues.map((issue, i) => (
                                <div key={i} className="p-3 bg-red-50 border-l-4 border-red-500 text-red-700 mb-2">
                                  <p className="font-semibold">{issue.field}</p>
                                  <p className="text-sm">{issue.message}</p>
                                </div>
                              ))}
                            </div>
                          )}

                          {result.validation.valid.length > 0 && (
                            <div className="mt-4">
                              <h4 className="font-semibold text-gray-800 mb-2">Valid Fields:</h4>
                              {result.validation.valid.map((v, i) => (
                                <div key={i} className="p-2 bg-green-50 text-green-700 mb-1 rounded text-sm">
                                  âœ“ {v.field}: {v.value}
                                </div>
                              ))}
                            </div>
                          )}

                          <button
                            onClick={() => downloadReport(result)}
                            className="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 rounded"
                          >
                            Download Report
                          </button>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<InvoiceUploadValidator />);
    </script>
</body>
</html>
